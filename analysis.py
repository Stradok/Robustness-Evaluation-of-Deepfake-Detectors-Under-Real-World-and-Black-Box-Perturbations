#!/usr/bin/env python3
"""
analysis.py

Reads attack_results.csv (generated by black_box_attacks.py)
and produces:
 - Summary CSVs
 - Plots for report
 - Top attack ranking

Outputs written to:
  per_model_summary.csv
  per_attack_summary.csv
  per_attack_severity_summary.csv
  final_attack_summary.csv
  plots/*.png
"""

import os
import pandas as pd
import matplotlib.pyplot as plt

def ensure_dir(path):
    if not os.path.exists(path):
        os.makedirs(path)


def main():

    input_csv = "attacks_out/full_attack_results.csv"
    print(f"[INFO] Loading CSV: {input_csv}")

    df = pd.read_csv(input_csv)

    # ------------------------------
    # Create plots directory
    # ------------------------------
    PLOT_DIR = "plots"
    ensure_dir(PLOT_DIR)

    # ------------------------------
    # 1. Per-Model Summary
    # ------------------------------
    print("[INFO] Computing per-model summary...")

    per_model = df.groupby("model").agg(
        fooling_rate=("fooled", "mean"),
        avg_psnr=("psnr", "mean"),
        avg_ssim=("ssim", "mean")
    ).reset_index()

    per_model["fooling_rate"] *= 100

    per_model_path = "per_model_summary.csv"
    per_model.to_csv(per_model_path, index=False)
    print(f"[SAVED] {per_model_path}")

    # Plot: Fooling Rate Per Model
    plt.figure(figsize=(8, 6))
    plt.bar(per_model["model"], per_model["fooling_rate"])
    plt.ylabel("Fooling Rate (%)")
    plt.title("Model Robustness Under All Attacks")
    plt.tight_layout()
    plt.savefig(f"{PLOT_DIR}/per_model_fooling.png")
    plt.close()

    # ------------------------------
    # 2. Per-Attack Summary
    # ------------------------------
    print("[INFO] Computing per-attack-type summary...")

    per_attack = df.groupby("attack_type").agg(
        fooling_rate=("fooled", "mean"),
        avg_psnr=("psnr", "mean"),
        avg_ssim=("ssim", "mean")
    ).reset_index()

    per_attack["fooling_rate"] *= 100

    per_attack_path = "per_attack_summary.csv"
    per_attack.to_csv(per_attack_path, index=False)
    print(f"[SAVED] {per_attack_path}")

    # Plot: Fooling Rate Per Attack
    plt.figure(figsize=(10, 6))
    plt.bar(per_attack["attack_type"], per_attack["fooling_rate"])
    plt.ylabel("Fooling Rate (%)")
    plt.title("Attack Strength Comparison")
    plt.xticks(rotation=45, ha="right")
    plt.tight_layout()
    plt.savefig(f"{PLOT_DIR}/per_attack_fooling.png")
    plt.close()

    # ------------------------------
    # 3. Severity Curve Summary
    # ------------------------------
    print("[INFO] Computing per-attack severity summary...")

    per_severity = df.groupby(["attack_type", "param"]).agg(
        fooling_rate=("fooled", "mean"),
        avg_psnr=("psnr", "mean"),
        avg_ssim=("ssim", "mean")
    ).reset_index()

    per_severity["fooling_rate"] *= 100

    per_severity_path = "per_attack_severity_summary.csv"
    per_severity.to_csv(per_severity_path, index=False)
    print(f"[SAVED] {per_severity_path}")

    # Plot Severity Curves
    plt.figure(figsize=(10, 6))
    for attack in per_severity["attack_type"].unique():
        subset = per_severity[per_severity["attack_type"] == attack]
        plt.plot(subset["param"], subset["fooling_rate"], marker="o", label=attack)

    plt.xlabel("Attack Parameter (severity)")
    plt.ylabel("Fooling Rate (%)")
    plt.title("Severity Curves for All Attacks")
    plt.legend()
    plt.tight_layout()
    plt.savefig(f"{PLOT_DIR}/attack_severity_curves.png")
    plt.close()

    # ------------------------------
    # 4. PSNR and SSIM Scatter Plots
    # ------------------------------
    # PSNR vs Fooling
    plt.figure(figsize=(8, 6))
    plt.scatter(df["psnr"], df["fooled"], alpha=0.4)
    plt.xlabel("PSNR")
    plt.ylabel("Fooled (0/1)")
    plt.title("PSNR vs Fooling")
    plt.tight_layout()
    plt.savefig(f"{PLOT_DIR}/psnr_vs_fooling.png")
    plt.close()

    # SSIM vs Fooling
    plt.figure(figsize=(8, 6))
    plt.scatter(df["ssim"], df["fooled"], alpha=0.4)
    plt.xlabel("SSIM")
    plt.ylabel("Fooled (0/1)")
    plt.title("SSIM vs Fooling")
    plt.tight_layout()
    plt.savefig(f"{PLOT_DIR}/ssim_vs_fooling.png")
    plt.close()

    # ------------------------------
    # 5. Top 5 Most Damaging Attacks
    # ------------------------------
    df_attack_rank = df.groupby(["attack_type", "param"]).agg(
        fooling_rate=("fooled", "mean")
    ).reset_index()

    df_attack_rank["fooling_rate"] *= 100
    top5 = df_attack_rank.sort_values(by="fooling_rate", ascending=False).head(5)

    summary_path = "final_attack_summary.csv"
    top5.to_csv(summary_path, index=False)
    print(f"[SAVED] {summary_path}")

    # ------------------------------
    # 6. Display Console Output
    # ------------------------------
    print("\n====================")
    print("PER MODEL SUMMARY")
    print("====================")
    print(per_model)

    print("\n====================")
    print("PER ATTACK SUMMARY")
    print("====================")
    print(per_attack)

    print("\n====================")
    print("TOP 5 ATTACKS")
    print("====================")
    print(top5)

    print("\n[DONE] Full analysis completed.")
    print(f"Plots saved to: {PLOT_DIR}/")


if __name__ == "__main__":
    main()
